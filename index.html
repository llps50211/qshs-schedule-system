<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>清水高中智慧課表 | Smart Scheduler 3.0</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 280px;
            --primary-blue: #004e92;
            --primary-orange: #ed8b00;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Noto Sans TC', sans-serif; 
            background: #f5f5f7;
            color: #1d1d1f;
            overflow: hidden; /* App-like feel */
        }
        
        /* MacOS Glassmorphism */
        .glass-sidebar {
            background: rgba(245, 245, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05);
        }

        .mac-button {
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .mac-button:active {
            transform: scale(0.96);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

        /* Animation */
        .animate-enter { animation: enter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes enter {
            from { opacity: 0; transform: scale(0.98) translateY(5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Print */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; overflow: visible; }
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        qingshui: {
                            blue: '#004e92', 
                            orange: '#ed8b00',
                        },
                        mac: {
                            gray: '#f5f5f7',
                            hover: 'rgba(0,0,0,0.05)',
                            active: 'rgba(0,0,0,0.08)',
                            blue: '#007AFF'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Gemini API Config (請填入您的 API Key) ---
        // 注意：為了安全，實際部署時建議不要將 Key 直接寫在前端，或使用 Proxy
        const GEMINI_API_KEY = ""; 
        const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // --- Mock Data for Demo ---
        const MOCK_DATA = `id0,no0,id2,id3,a0,b0,a1,b1,a2,b2,a3,b3,a4,b4,a5,b5,a6,b6,a7,b7,a8,b8
1,001,範例陳師,專任教師,數學,101,數學,102,,,,,數學,103,,,,,,數學,101,,,,,
2,002,範例林師,導師,國文,201,,,,,國文,202,國文,203,,,,,,班會,201,,,,,
3,003,範例王師,教務主任,,,,,,,,,,物理,實驗室,,,,,,物理,103,,,,,,,,`;

        // --- Helper: Robust Icon Component (Fixes removeChild error) ---
        const Icon = ({ name, size = 18, className = "", color = "currentColor" }) => {
            const [svgHtml, setSvgHtml] = useState(null);

            useEffect(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    // Render to SVG string directly instead of relying on DOM replacement
                    // This prevents React reconciliation conflicts
                    const svg = window.lucide.icons[name].toSvg({
                        width: size,
                        height: size,
                        class: className,
                        stroke: color
                    });
                    setSvgHtml(svg);
                }
            }, [name, size, className, color]);

            if (!svgHtml) return <span className="w-4 h-4 block bg-gray-200 rounded animate-pulse"></span>;
            
            return <span 
                dangerouslySetInnerHTML={{ __html: svgHtml }} 
                className="inline-flex items-center justify-center"
            />;
        };

        // --- Helper: LocalStorage Manager ---
        const Storage = {
            get: (key, def) => {
                try {
                    const item = localStorage.getItem(`qs_schedule_${key}`);
                    return item ? JSON.parse(item) : def;
                } catch { return def; }
            },
            set: (key, val) => {
                try { localStorage.setItem(`qs_schedule_${key}`, JSON.stringify(val)); } catch {}
            }
        };

        // --- Core: CSV Parser ---
        const parseCSV = (text) => {
            const lines = text.split(/\r\n|\n/).filter(l => l.trim() !== '');
            if (lines.length < 2) return [];
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Handle quotes
                if (cols.length < 5) continue;
                const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';
                
                const teacherName = clean(cols[2]);
                if(!teacherName) continue;

                const role = clean(cols[3]);
                const schedule = {}; 

                for (let x = 0; x <= 48; x++) {
                    const calcIndexA = 4 + (x * 2); 
                    const calcIndexB = 5 + (x * 2);
                    const course = clean(cols[calcIndexA]);
                    const room = clean(cols[calcIndexB]);
                    if (course || room) {
                        const day = Math.floor(x / 10);
                        const period = x % 10; 
                        if (!schedule[day]) schedule[day] = {};
                        schedule[day][period] = { course, room, id: x };
                    }
                }
                data.push({ id: clean(cols[0]) || `row-${i}`, name: teacherName, role: role, schedule });
            }
            return data;
        };

        // --- Core: ICS Generator ---
        const generateICS = (teacher) => {
            let content = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//QingshuiHS//Schedule//TW\n";
            const days = ["MO", "TU", "WE", "TH", "FR"];
            Object.keys(teacher.schedule).forEach(d => {
                Object.keys(teacher.schedule[d]).forEach(p => {
                    const slot = teacher.schedule[d][p];
                    if(slot.course) {
                        const startH = 8 + parseInt(p);
                        content += `BEGIN:VEVENT\nSUMMARY:${slot.course}\nLOCATION:${slot.room||''}\nRRULE:FREQ=WEEKLY;BYDAY=${days[d]}\nDTSTART;TZID=Asia/Taipei:20250901T${startH < 10 ? '0'+startH : startH}0000\nDTEND;TZID=Asia/Taipei:20250901T${startH < 10 ? '0'+startH : startH}5000\nEND:VEVENT\n`;
                    }
                });
            });
            content += "END:VCALENDAR";
            return content;
        };

        // --- Gemini Call ---
        const callAI = async (prompt) => {
            if (!GEMINI_API_KEY) return "請先設定 API Key 才能使用 AI 功能。";
            try {
                const res = await fetch(`${GEMINI_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI 暫時無法回應";
            } catch (e) { return "連線錯誤: " + e.message; }
        };

        // --- UI Components ---

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col border border-white/50 animate-enter">
                        <div className="flex justify-between items-center p-5 border-b border-gray-200/50">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-black/5 rounded-full transition"><Icon name="x" /></button>
                        </div>
                        <div className="overflow-y-auto p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const ScheduleGrid = ({ schedule, highlightCommon, commonSlots }) => {
            const days = ["一", "二", "三", "四", "五"];
            const periods = [0,1,2,3,4,5,6,7,8,9];
            return (
                <div className="border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                    <div className="grid grid-cols-6 border-b bg-gray-50 text-xs font-bold text-gray-500">
                        <div className="p-2 text-center border-r">節</div>
                        {days.map(d => <div key={d} className="p-2 text-center border-r last:border-0">週{d}</div>)}
                    </div>
                    {periods.map(p => (
                        <div key={p} className="grid grid-cols-6 border-b last:border-0 min-h-[60px]">
                            <div className="p-2 flex items-center justify-center text-gray-400 bg-gray-50 text-sm border-r font-medium">
                                {p === 0 ? '早' : p}
                            </div>
                            {days.map((_, d) => {
                                const slot = schedule[d]?.[p];
                                const isCommon = highlightCommon && commonSlots?.some(c => c.day === d && c.period === p);
                                const cellBg = isCommon ? 'bg-green-50' : (slot?.course ? '' : '');
                                return (
                                    <div key={d} className={`p-1 border-r last:border-0 relative flex flex-col items-center justify-center text-center transition-colors ${cellBg}`}>
                                        {slot?.course ? (
                                            <>
                                                <div className="text-xs font-bold text-gray-800 line-clamp-2">{slot.course}</div>
                                                {slot.room && <div className="text-[10px] text-qingshui-blue bg-blue-50 px-1 rounded mt-1">{slot.room}</div>}
                                            </>
                                        ) : (isCommon && <div className="flex flex-col items-center text-green-600"><Icon name="check-circle" size={12}/><span className="text-[10px] font-bold">可排</span></div>)}
                                    </div>
                                )
                            })}
                        </div>
                    ))}
                </div>
            )
        };

        // --- Main App ---
        const App = () => {
            // Data States
            const [teachers, setTeachers] = useState([]);
            const [customTeachers, setCustomTeachers] = useState(Storage.get('teachers', []));
            const [communities, setCommunities] = useState(Storage.get('communities', []));
            const [logs, setLogs] = useState(Storage.get('logs', []));
            const [customRooms, setCustomRooms] = useState(Storage.get('rooms', []));
            
            // View States
            const [activeTab, setActiveTab] = useState('teachers'); // teachers, compare, community, admin, rooms
            const [selectedTeacherIds, setSelectedTeacherIds] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [viewTeacher, setViewTeacher] = useState(null); // Modal Data
            const [aiReport, setAiReport] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);

            // Derived Data
            const allTeachers = useMemo(() => [...teachers, ...customTeachers], [teachers, customTeachers]);
            
            // Initial Load
            useEffect(() => {
                fetch('114師表.csv').then(r => r.ok ? r.text() : Promise.reject())
                    .then(txt => setTeachers(parseCSV(txt)))
                    .catch(() => console.warn("請上傳 CSV"));
            }, []);

            // Role Logic
            const getCategory = (t) => {
                const id = parseInt(t.id) || 0;
                if(t.role?.includes('主任') || t.role?.includes('組長')) return '行政人員';
                if(t.role?.includes('導師')) return id % 2 === 0 ? '國中導師' : '高中導師';
                if(t.role?.includes('專任')) return id % 2 === 0 ? '高中部專任' : '國中部專任';
                return '其他';
            };

            // Common Slots Logic
            const getCommonSlots = (tIds) => {
                const targets = allTeachers.filter(t => tIds.includes(t.id));
                if(targets.length < 2) return [];
                const slots = [];
                for(let d=0; d<5; d++) {
                    for(let p=0; p<10; p++) {
                        if(targets.every(t => !t.schedule[d]?.[p]?.course)) slots.push({day:d, period:p});
                    }
                }
                return slots;
            };

            // Actions
            const addLog = (action) => {
                const newLog = { time: new Date().toLocaleString(), action };
                const newLogs = [newLog, ...logs].slice(0, 50);
                setLogs(newLogs);
                Storage.set('logs', newLogs);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setTeachers(parseCSV(ev.target.result));
                        addLog(`匯入 CSV: ${file.name}`);
                    };
                    reader.readAsText(file);
                }
            };

            const downloadICS = (t) => {
                const blob = new Blob([generateICS(t)], {type: 'text/calendar'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${t.name}_課表.ics`;
                a.click();
            };

            const runAIAnalysis = async (type, data) => {
                setIsAiLoading(true);
                let prompt = "";
                if(type === 'schedule') {
                    prompt = `分析以下共同空堂: ${JSON.stringify(data.slots)}，參與者: ${data.names}。請推薦最佳會議時間並寫一段開會通知。`;
                } else if (type === 'course') {
                    prompt = `分析課程: ${data.courseName}。請給出教學目標(3點)和關鍵字。`;
                }
                const res = await callAI(prompt);
                setAiReport(res);
                setIsAiLoading(false);
            };

            // --- Sub-Views ---

            const Sidebar = () => (
                <aside className="glass-sidebar w-[280px] h-screen flex flex-col fixed left-0 top-0 z-20 overflow-y-auto no-print">
                    <div className="p-6">
                        <div className="flex items-center gap-3 mb-8">
                            <div className="w-10 h-10 bg-gradient-to-br from-qingshui-blue to-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-500/20">清</div>
                            <div>
                                <h1 className="font-bold text-gray-900 tracking-tight">清水高中</h1>
                                <p className="text-xs text-gray-500 font-medium">智慧課表 3.0</p>
                            </div>
                        </div>

                        <div className="space-y-1">
                            {[
                                {id: 'teachers', icon: 'users', label: '教師名錄'},
                                {id: 'compare', icon: 'git-merge', label: '空堂比對'},
                                {id: 'community', icon: 'coffee', label: '教師社群 (揪團)'},
                                {id: 'rooms', icon: 'map-pin', label: '空間/課程檢索'},
                                {id: 'admin', icon: 'settings', label: '系統管理'},
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all mac-button
                                        ${activeTab === item.id ? 'bg-white shadow text-qingshui-blue' : 'text-gray-600 hover:bg-black/5'}`}
                                >
                                    <Icon name={item.icon} size={18} />
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="mt-auto p-6 border-t border-gray-200">
                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                            <h4 className="text-xs font-bold text-gray-400 uppercase mb-2">System Status</h4>
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                <span className={`w-2 h-2 rounded-full ${allTeachers.length > 0 ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                {allTeachers.length} 位教師
                            </div>
                        </div>
                    </div>
                </aside>
            );

            const TeacherView = () => {
                const [filter, setFilter] = useState('All');
                const categories = ['All', '行政人員', '高中導師', '國中導師', '高中部專任', '國中部專任', '其他'];
                
                const filtered = allTeachers.filter(t => {
                    const matchCat = filter === 'All' || getCategory(t) === filter;
                    const matchSearch = t.name.includes(searchQuery);
                    return matchCat && matchSearch;
                });

                return (
                    <div className="p-8 max-w-7xl mx-auto animate-enter">
                        <header className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-900">教師名錄</h2>
                            <div className="relative">
                                <Icon name="search" className="absolute left-3 top-2.5 text-gray-400" size={16} />
                                <input 
                                    type="text" 
                                    placeholder="搜尋教師..." 
                                    className="pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-qingshui-blue focus:outline-none shadow-sm w-64"
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                />
                            </div>
                        </header>

                        <div className="flex gap-2 overflow-x-auto pb-4 mb-2 no-scrollbar">
                            {categories.map(c => (
                                <button key={c} onClick={() => setFilter(c)} 
                                    className={`px-4 py-1.5 rounded-full text-xs font-medium border transition ${filter === c ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'}`}>
                                    {c}
                                </button>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filtered.map(t => {
                                const isSel = selectedTeacherIds.includes(t.id);
                                return (
                                    <div key={t.id} className={`bg-white p-4 rounded-xl border transition hover:shadow-md cursor-pointer group ${isSel ? 'border-qingshui-blue ring-1 ring-qingshui-blue' : 'border-gray-200'}`}
                                         onClick={() => setSelectedTeacherIds(prev => prev.includes(t.id) ? prev.filter(i=>i!==t.id) : [...prev, t.id])}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 font-bold group-hover:bg-blue-50 group-hover:text-qingshui-blue transition">
                                                    {t.name[0]}
                                                </div>
                                                <div>
                                                    <div className="font-bold text-gray-900">{t.name}</div>
                                                    <div className="text-xs text-gray-500">{getCategory(t)}</div>
                                                </div>
                                            </div>
                                            <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${isSel ? 'bg-qingshui-blue border-qingshui-blue text-white' : 'border-gray-300'}`}>
                                                {isSel && <Icon name="check" size={12}/>}
                                            </div>
                                        </div>
                                        <div className="mt-3 pt-3 border-t border-gray-100 flex justify-end">
                                            <button onClick={(e) => { e.stopPropagation(); setViewTeacher(t); }} className="text-xs font-bold text-gray-500 hover:text-qingshui-blue flex items-center gap-1">
                                                <Icon name="eye" size={14}/> 檢視課表
                                            </button>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            const CommunityView = () => {
                const [newGroup, setNewGroup] = useState('');
                
                const createGroup = () => {
                    if(!newGroup) return;
                    const group = {
                        id: Date.now(),
                        name: newGroup,
                        members: [], // List of Teacher IDs
                        created: new Date().toLocaleDateString()
                    };
                    const updated = [group, ...communities];
                    setCommunities(updated);
                    Storage.set('communities', updated);
                    setNewGroup('');
                    addLog(`建立社群: ${group.name}`);
                };

                const joinGroup = (gId) => {
                    // Logic: Add currently selected teachers to this group
                    if(selectedTeacherIds.length === 0) return alert("請先在「教師名錄」勾選要加入的老師");
                    
                    const updated = communities.map(g => {
                        if(g.id === gId) {
                            const newMembers = [...new Set([...g.members, ...selectedTeacherIds])];
                            return { ...g, members: newMembers };
                        }
                        return g;
                    });
                    setCommunities(updated);
                    Storage.set('communities', updated);
                    addLog(`更新社群成員: Group ${gId}`);
                    setSelectedTeacherIds([]); // Reset selection
                };

                const analyzeGroup = (g) => {
                    const slots = getCommonSlots(g.members);
                    const memberNames = allTeachers.filter(t => g.members.includes(t.id)).map(t => t.name).join(', ');
                    
                    return (
                        <div className="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <div className="font-bold text-gray-700 mb-2">社群智慧分析</div>
                            <div className="text-gray-600 mb-1">成員 ({g.members.length}): {memberNames}</div>
                            <div className="text-gray-600 mb-2">共同空堂: {slots.length > 0 ? `${slots.length} 個時段` : '無共同時段'}</div>
                            {slots.slice(0, 3).map((s, i) => (
                                <span key={i} className="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded mr-2 text-xs">
                                    週{["一","二","三","四","五"][s.day]} 第{s.period}節
                                </span>
                            ))}
                            {slots.length > 0 && (
                                <button 
                                    onClick={() => runAIAnalysis('schedule', {slots: slots.slice(0,5), names: memberNames})}
                                    className="block mt-3 text-qingshui-blue hover:underline flex items-center gap-1"
                                >
                                    <Icon name="sparkles" size={14}/> 請 AI 規劃活動
                                </button>
                            )}
                        </div>
                    );
                };

                return (
                    <div className="p-8 max-w-4xl mx-auto animate-enter">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <Icon name="coffee" className="text-qingshui-orange"/> 教師社群 (揪團)
                        </h2>
                        
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
                            <h3 className="font-bold text-lg mb-4">發起新團體</h3>
                            <div className="flex gap-3">
                                <input 
                                    value={newGroup}
                                    onChange={e => setNewGroup(e.target.value)}
                                    placeholder="例如：週三健康便當團、高一雙語備課團..."
                                    className="flex-1 px-4 py-2 border rounded-xl focus:ring-2 focus:ring-qingshui-orange focus:outline-none"
                                />
                                <button onClick={createGroup} className="px-6 py-2 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition">
                                    開團
                                </button>
                            </div>
                        </div>

                        <div className="space-y-6">
                            {communities.length === 0 && <div className="text-center text-gray-400 py-10">尚無社群，快來當主揪！</div>}
                            {communities.map(g => (
                                <div key={g.id} className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-xl font-bold text-gray-800">{g.name}</h3>
                                            <p className="text-xs text-gray-400 mt-1">建立於 {g.created} • {g.members.length} 人參加</p>
                                        </div>
                                        <button onClick={() => joinGroup(g.id)} className="px-4 py-2 bg-blue-50 text-qingshui-blue rounded-lg font-bold text-sm hover:bg-blue-100 transition flex items-center gap-2">
                                            <Icon name="user-plus" size={16}/> 
                                            {selectedTeacherIds.length > 0 ? `加入選取的 ${selectedTeacherIds.length} 人` : '+1 加入'}
                                        </button>
                                    </div>
                                    {analyzeGroup(g)}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const AdminView = () => {
                const [newName, setNewName] = useState('');
                const [newRole, setNewRole] = useState('');

                const addTeacher = () => {
                    if(!newName || !newRole) return;
                    const newT = { id: `custom-${Date.now()}`, name: newName, role: newRole, schedule: {0:{},1:{},2:{},3:{},4:{}} };
                    const updated = [...customTeachers, newT];
                    setCustomTeachers(updated);
                    Storage.set('teachers', updated);
                    setNewName(''); setNewRole('');
                    addLog(`新增教師: ${newName}`);
                };

                const deleteTeacher = (id) => {
                    if(!confirm("確定刪除？")) return;
                    const updated = customTeachers.filter(t => t.id !== id);
                    setCustomTeachers(updated);
                    Storage.set('teachers', updated);
                    addLog(`刪除教師 ID: ${id}`);
                };

                return (
                    <div className="p-8 max-w-5xl mx-auto animate-enter">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">系統管理後台</h2>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Teacher Management */}
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="user-plus"/> 新增教師 (手動)</h3>
                                    <div className="space-y-3">
                                        <input value={newName} onChange={e=>setNewName(e.target.value)} placeholder="姓名" className="w-full p-2 border rounded-lg"/>
                                        <select value={newRole} onChange={e=>setNewRole(e.target.value)} className="w-full p-2 border rounded-lg">
                                            <option value="">選擇職稱...</option>
                                            <option value="專任教師">專任教師</option>
                                            <option value="導師">導師</option>
                                            <option value="行政人員">行政人員</option>
                                        </select>
                                        <button onClick={addTeacher} className="w-full py-2 bg-qingshui-blue text-white rounded-lg font-bold">新增存檔</button>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <h3 className="font-bold text-gray-800 mb-4">自定義教師名單</h3>
                                    {customTeachers.length === 0 && <p className="text-gray-400 text-sm">無自定義資料</p>}
                                    <ul className="space-y-2 max-h-60 overflow-y-auto">
                                        {customTeachers.map(t => (
                                            <li key={t.id} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                <span>{t.name} ({t.role})</span>
                                                <button onClick={()=>deleteTeacher(t.id)} className="text-red-500 hover:text-red-700"><Icon name="trash-2" size={14}/></button>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>

                            {/* Logs */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 h-fit">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="clipboard-list"/> 操作稽核紀錄</h3>
                                <div className="space-y-3 max-h-[500px] overflow-y-auto">
                                    {logs.length === 0 && <p className="text-gray-400 text-sm">暫無紀錄</p>}
                                    {logs.map((log, i) => (
                                        <div key={i} className="text-sm border-b pb-2 last:border-0">
                                            <div className="text-xs text-gray-400">{log.time}</div>
                                            <div className="text-gray-700">{log.action}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const RoomView = () => {
                const [term, setTerm] = useState('');
                const roomData = useMemo(() => {
                    const rooms = {};
                    allTeachers.forEach(t => {
                        for(let d=0; d<5; d++) {
                            for(let p=0; p<10; p++) {
                                const slot = t.schedule[d][p];
                                if(slot?.room) {
                                    if(!rooms[slot.room]) rooms[slot.room] = [];
                                    rooms[slot.room].push({day:d, period:p, teacher:t.name, course:slot.course});
                                }
                            }
                        }
                    });
                    return rooms;
                }, [allTeachers]);

                const filteredRooms = Object.keys(roomData).filter(r => r.includes(term)).sort();

                return (
                    <div className="p-8 max-w-6xl mx-auto animate-enter">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">空間與課程檢索</h2>
                        <input 
                            value={term} 
                            onChange={e => setTerm(e.target.value)} 
                            placeholder="輸入教室名稱 (如: 101, 美術教室)..." 
                            className="w-full p-4 text-lg border rounded-xl shadow-sm mb-8 focus:ring-2 focus:ring-qingshui-blue focus:outline-none"
                        />
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {filteredRooms.map(r => (
                                <div key={r} className="bg-white p-4 rounded-xl shadow-sm border hover:shadow-md transition">
                                    <h3 className="font-bold text-lg text-qingshui-orange mb-2">{r}</h3>
                                    <p className="text-xs text-gray-500">{roomData[r].length} 堂課使用中</p>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // --- Root Render ---
            return (
                <div className="flex h-screen w-full">
                    <Sidebar />
                    <main className="flex-1 ml-[280px] h-full overflow-y-auto bg-[#f5f5f7]">
                        {/* Empty State / Upload */}
                        {allTeachers.length === 0 && (
                            <div className="flex flex-col items-center justify-center h-full">
                                <div className="w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center mb-6">
                                    <Icon name="upload-cloud" size={48} className="text-qingshui-blue"/>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">歡迎使用智慧課表系統</h2>
                                <p className="text-gray-500 mb-8">請上傳 CSV 檔案以開始</p>
                                <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" id="csv-upload"/>
                                <button onClick={() => document.getElementById('csv-upload').click()} className="px-8 py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition">
                                    選擇檔案
                                </button>
                                <button onClick={() => setTeachers(parseCSV(MOCK_DATA))} className="mt-4 text-sm text-gray-400 hover:text-gray-600 underline">
                                    載入範例資料
                                </button>
                            </div>
                        )}

                        {allTeachers.length > 0 && (
                            <>
                                {activeTab === 'teachers' && <TeacherView />}
                                {activeTab === 'community' && <CommunityView />}
                                {activeTab === 'admin' && <AdminView />}
                                {activeTab === 'rooms' && <RoomView />}
                                {activeTab === 'compare' && (
                                    <div className="p-8 max-w-6xl mx-auto animate-enter">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6">
                                            <h2 className="text-xl font-bold mb-4">空堂比對</h2>
                                            <div className="flex flex-wrap gap-2 mb-4 min-h-[40px]">
                                                {selectedTeacherIds.length === 0 && <span className="text-gray-400 text-sm py-1">請先至「教師名錄」勾選老師...</span>}
                                                {allTeachers.filter(t => selectedTeacherIds.includes(t.id)).map(t => (
                                                    <span key={t.id} className="px-3 py-1 bg-blue-50 text-qingshui-blue rounded-full text-sm font-bold flex items-center gap-2">
                                                        {t.name} <button onClick={()=>setSelectedTeacherIds(ids=>ids.filter(i=>i!==t.id))}><Icon name="x" size={12}/></button>
                                                    </span>
                                                ))}
                                            </div>
                                            {selectedTeacherIds.length > 1 && (
                                                <button 
                                                    onClick={() => runAIAnalysis('schedule', {slots: getCommonSlots(selectedTeacherIds), names: selectedTeacherIds.join(',')})}
                                                    className="w-full py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg font-bold shadow hover:opacity-90 transition flex justify-center items-center gap-2"
                                                >
                                                    {isAiLoading ? '分析中...' : <><Icon name="sparkles" size={18}/> AI 智慧排程建議</>}
                                                </button>
                                            )}
                                        </div>
                                        {selectedTeacherIds.length > 1 && (
                                            <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                                <ScheduleGrid schedule={{}} highlightCommon={true} commonSlots={getCommonSlots(selectedTeacherIds)} />
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    {/* AI Report Modal */}
                    <Modal isOpen={!!aiReport} onClose={() => setAiReport('')} title="✨ AI 智慧分析報告">
                        <div className="prose max-w-none text-gray-800 whitespace-pre-line leading-relaxed">
                            {aiReport}
                        </div>
                    </Modal>

                    {/* Teacher Detail Modal */}
                    <Modal isOpen={!!viewTeacher} onClose={() => setViewTeacher(null)} title={`${viewTeacher?.name} 老師課表`}>
                        {viewTeacher && (
                            <div>
                                <div className="flex justify-between mb-6">
                                    <div className="text-sm text-gray-500">{viewTeacher.role}</div>
                                    <button onClick={() => downloadICS(viewTeacher)} className="text-qingshui-blue hover:underline flex items-center gap-1 text-sm font-bold">
                                        <Icon name="download" size={14}/> 匯出 Google 日曆 (.ics)
                                    </button>
                                </div>
                                <ScheduleGrid schedule={viewTeacher.schedule} />
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
